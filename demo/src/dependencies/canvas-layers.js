/*! canvas-layers - v2.1.2 */
class Canvas{constructor(t,e={}){this.canvas=t,this.width=t.width,this.height=t.height,this.ctx=t.getContext("2d"),this.layers=[],this.layer_state_pos=-1,this.layer_states=[],this.drawPromises=[],this.activeLayer=null,this.shiftKeyDown=!1,this.draggingActiveLayer=!1,this.resizingActiveLayer=!1,this.rotatingActiveLayer=!1,this.lastMouseDownOffset={x:0,y:0},this.activeLayerMouseOffset={x:0,y:0},this.activeLayerOriginalDimensions={width:0,height:0},this.activeLayerRotateStartPos={x:0,y:0},this.displayGrid=!1,this.snapToGrid=!1,this.gridDistancePixels=10,this._onmousemove=this.onmousemove.bind(this),this._onmousedown=this.onmousedown.bind(this),this._onmousereset=this.onmousereset.bind(this),this._onclick=this.onclick.bind(this),this._ondblclick=this.ondblclick.bind(this),this._onkeyevent=this.onkeyevent.bind(this),t.addEventListener("mousemove",this._onmousemove),t.addEventListener("mousedown",this._onmousedown),t.addEventListener("mouseout",this._onmousereset),t.addEventListener("mouseup",this._onmousereset),t.addEventListener("click",this._onclick),t.addEventListener("dblclick",this._ondblclick),document.addEventListener("keydown",this._onkeyevent),document.addEventListener("keyup",this._onkeyevent),this.anchorRadius=e.anchorRadius||Canvas.anchorRadius,this.strokeStyle=e.strokeStyle||Canvas.strokeStyle,this.fillStyle=e.fillStyle||Canvas.fillStyle,this.lineWidth=e.lineWidth||Canvas.lineWidth,this.cursors=e.cursors||{},this.cursors.default=this.cursors.default||Canvas.cursors.default,this.cursors.grab=this.cursors.grab||Canvas.cursors.grab,this.cursors.grabbing=this.cursors.grabbing||Canvas.cursors.grabbing,this.cursors.move=this.cursors.move||Canvas.cursors.move,this.cursors.rotate=this.cursors.rotate||Canvas.cursors.rotate,this.cursors.rotating=this.cursors.rotating||Canvas.cursors.rotating,this.last_clicked_layer=null,this.pending_layers=0,this.ready=!0,this.muteStateChanges=!1,this.isCtrlPressed=!1,this.ctrlGroupLayer=new CanvasLayerGroup("ctrl-grp")}isLayerInGroup(t){return!!~this.ctrlGroupLayer.layers.indexOf(t)}isGroupOnCanvas(){return!!~this.layers.indexOf(this.ctrlGroupLayer)}async destroyCtrlGroup(){this.muteStateChanges=!0;var t=this.ctrlGroupLayer.layers.map(t=>new Promise(e=>{this.addLayer(t),t.onload(()=>e())}));await Promise.all(t),this.ctrlGroupLayer.layers=[],this.ctrlGroupLayer.rotation=0,this.isGroupOnCanvas()&&this.removeLayer(this.ctrlGroupLayer),this.muteStateChanges=!1}loadState(t){this.layers=t.map(t=>CanvasLayer.deobjectify(t)),this.draggingActiveLayer=!1,this.resizingActiveLayer=!1,this.rotatingActiveLayer=!1,this.lastMouseDownOffset={x:0,y:0},this.activeLayerMouseOffset={x:0,y:0},this.activeLayerOriginalDimensions={width:0,height:0},this.activeLayerRotateStartPos={x:0,y:0},this.draw()}saveState(){if(this.muteStateChanges)return;var t=[];const e=i=>{i.forEach(i=>{i instanceof CanvasLayerGroup?e(i.layers):t.push(i.objectify())})};e(this.layers),this.layer_states.length=this.layer_state_pos+1,this.layer_states.push(t),this.layer_state_pos=this.layer_states.length-1}undo(){this.layer_state_pos>0&&(this.layer_state_pos--,this.loadState(this.layer_states[this.layer_state_pos]))}redo(){this.layer_state_pos+1<this.layer_states.length&&(this.layer_state_pos++,this.loadState(this.layer_states[this.layer_state_pos]))}snapOn(t=10){this.snapToGrid=!0,t=+t<3?3:+t,this.gridDistancePixels=t}snapOff(){this.snapToGrid=!1,this.draw()}showGrid(t=10){this.displayGrid=!0,t=+t<3?3:+t,this.gridDistancePixels=t,this.draw()}hideGrid(){this.displayGrid=!1,this.draw()}getLayerByName(t){for(var e=this.layers.length;e--;)if(this.layers[e].name===t)return this.layers[e];return null}addLayer(t,e={}){if(this.ready=!1,t instanceof CanvasLayer)var i=t;else{const s=e.name||`Layer ${this.layers.length}`,a=parseFloat(e.x||this.width/2),r=parseFloat(e.y||this.height/2),h=parseFloat(e.rotation||0),n=void 0===e.draggable||e.draggable,o=void 0===!!e.rotateable||e.rotateable,l=void 0===!!e.resizable||e.resizable,y=void 0===!!e.selectable||e.selectable,c=e.width||null,d=e.height||null,v=e.forceBoundary||!1,u=!e.hasOwnProperty("allowOverlap")||!!e.allowOverlap;i=new CanvasLayer(t,s,a,r,c,d,h,n,o,l,y,v,u)}return this.layers.unshift(i),this.pending_layers++,i.onload(()=>{this.pending_layers--,0===this.pending_layers&&(this.ready=!0,this.draw(),this.saveState(),i instanceof CanvasLayerGroup||this.fireEvent("layer-added"))}),i}cropToLayer(t,e=!0){return this.extractPortion(t.x,t.y,t.width,t.height,t.rotation,e)}async extractPortion(t,e,i,s,a=0,r=!0){var h=a*Math.PI/180,{x:n,y:o}=Canvas.absolutePoint(-i/2,-s/2,t,e,a),l=this.getRotatedRectBB(n,o,i,s,h),y=document.createElement("canvas"),c=y.getContext("2d"),d=document.createElement("canvas"),v=d.getContext("2d"),u=document.createElement("canvas"),g=u.getContext("2d");d.width=u.width=l.width,d.height=u.height=l.height,y.width=this.width,y.height=this.height,await this.loadAll();for(let t=this.layers.length;t--;){let e=this.layers[t];h=e.rotation*(Math.PI/180);c.translate(e.x,e.y),c.rotate(h),c.drawImage(e.image,-e.width/2,-e.height/2,e.width,e.height),c.rotate(-h),c.translate(-e.x,-e.y)}if(v.drawImage(y,l.cx-l.width/2,l.cy-l.height/2,l.width,l.height,0,0,l.width,l.height),!r)return d.toDataURL();g.translate(d.width/2,d.height/2),g.rotate(-h),g.drawImage(d,-d.width/2,-d.height/2);var L=(u.width-i)/2,x=(u.height-s)/2;return v.clearRect(0,0,d.width,d.height),d.width=i,d.height=s,v.drawImage(u,-L,-x),d.toDataURL()}draw(){return new Promise(t=>{if(this.drawPromises.push(t),this.ready){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(let t=this.layers.length;t--;){let i=this.layers[t];var e=i.rotation*(Math.PI/180);this.ctx.translate(i.x,i.y),this.ctx.rotate(e),this.ctx.drawImage(i.image,-i.width/2,-i.height/2,i.width,i.height),i===this.activeLayer&&(this.ctx.strokeStyle=this.strokeStyle,this.ctx.fillStyle=this.fillStyle,this.ctx.lineWidth=this.getScale()*this.lineWidth,this.ctx.strokeRect(-i.width/2,-i.height/2,i.width,i.height),i.resizable&&i.getCorners().forEach(t=>{this.drawCircle(t.x,t.y,this.getScale()*this.anchorRadius)}),i.rotateable&&(this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(i.width/2+25,0),this.ctx.stroke(),this.drawCircle(i.width/2+25,0,this.getScale()*this.anchorRadius))),this.ctx.rotate(-e),this.ctx.translate(-i.x,-i.y)}if(this.displayGrid){this.ctx.strokeStyle="rgba(0,0,0,0.2)",this.ctx.lineWidth=2*this.getScale();var{xs:i,ys:s}=this.getGridLines(!1);i.forEach(t=>{this.ctx.beginPath(),this.ctx.moveTo(t,0),this.ctx.lineTo(t,this.canvas.height),this.ctx.stroke()}),s.forEach(t=>{this.ctx.beginPath(),this.ctx.moveTo(0,t),this.ctx.lineTo(this.canvas.width,t),this.ctx.stroke()})}for(;this.drawPromises.length;)this.drawPromises.shift()();this.canvas.dispatchEvent(new CustomEvent("canvas-drawn"))}})}removeAllLayers(){this.deSelectLayer(),this.layers=[],this.draw()}destroy(){this.canvas&&(this.canvas.removeEventListener("mousemove",this._onmousemove),this.canvas.removeEventListener("mousedown",this._onmousedown),this.canvas.removeEventListener("mouseout",this._onmousereset),this.canvas.removeEventListener("mouseup",this._onmousereset),this.canvas.removeEventListener("click",this._onclick),this.canvas.removeEventListener("dblclick",this._ondblclick)),document.removeEventListener("keydown",this._onkeyevent),document.removeEventListener("keyup",this._onkeyevent),this.ctx&&this.canvas&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.removeAllLayers(),this.layers=[],this.layer_states=[],this.activeLayer=null,this.ctrlGroupLayer=null,this.canvas=null,this.ctx=null,this.ready=!1}removeLayer(t){t===this.activeLayer&&this.deSelectLayer(),this.layers.splice(this.layers.indexOf(t),1),this.saveState(),this.draw()}selectLayer(t){this.layers.unshift(this.layers.splice(this.layers.indexOf(t),1)[0]),this.activeLayer=t,this.draw(),this.fireEvent("layer-selected")}deSelectLayer(){this.activeLayer=null,this.draggingActiveLayer=!1,this.draw(),this.fireEvent("layer-deselected")}canvasMousePos(t){var e=this.canvas.getBoundingClientRect(),i=t.clientX-e.left,s=t.clientY-e.top,a=this.canvas.width/e.width,r=this.canvas.height/e.height;return{x:i*=a,y:s*=r}}getLayerAt(t,e){for(let i=0;i<this.layers.length;i++){let s=this.layers[i];if(Canvas.isOverLayer(t,e,s))return s}return null}isOverSelectableLayer(t,e){for(let i=this.layers.length;i--;)if(Canvas.isOverLayer(t,e,this.layers[i])&&this.layers[i].selectable&&this.activeLayer!==this.layers[i])return!0;return!1}getOverlappingLayers(t){for(var e=[],i=0;i<this.layers.length;i++)this.layers[i]!==t&&this.doLayersOverlap(t,this.layers[i])&&e.push(this.layers[i]);return e}getGridLines(t=!0){var e=[],i=[],s=0;s=t?this.gridDistancePixels:2*this.gridDistancePixels;for(var a=0;a<this.canvas.width;a+=this.getScale()*s)e.push(a);for(var r=0;r<this.canvas.height;r+=this.getScale()*s)i.push(r);for(let s=this.layers.length;s--;)t&&this.layers[s]===this.activeLayer||(e.push(this.layers[s].x),i.push(this.layers[s].y));return[...new Set(e)].sort(),[...new Set(i)].sort(),{xs:e,ys:i}}loadAll(){var t=this.layers.map(t=>t.load());return Promise.all(t)}getRotatedRectBB(t,e,i,s,a){var r=Math.abs(Math.cos(a)),h=Math.abs(Math.sin(a));return{cx:t+i/2*Math.cos(a)-s/2*Math.sin(a),cy:e+i/2*Math.sin(a)+s/2*Math.cos(a),width:i*r+s*h,height:i*h+s*r}}drawCircle(t,e,i){this.ctx.beginPath(),this.ctx.arc(t,e,i,0,2*Math.PI,!0),this.ctx.closePath(),this.ctx.fill()}onkeyevent(t){"Shift"===t.key&&("keydown"===t.type?this.shiftKeyDown=!0:this.shiftKeyDown=!1),"Control"===t.key&&("keydown"===t.type?this.isCtrlPressed=!0:this.isCtrlPressed=!1),!this.isCtrlPressed&&this.isGroupOnCanvas()&&this.destroyCtrlGroup()}doLayersOverlap(t,e){const i=t=>t.getCorners().map(e=>Canvas.absolutePoint(e.x,e.y,t.x,t.y,t.rotation)),s=t=>[[{x:t[0].x,y:t[0].y},{x:t[1].x,y:t[1].y}],[{x:t[1].x,y:t[1].y},{x:t[2].x,y:t[2].y}],[{x:t[2].x,y:t[2].y},{x:t[3].x,y:t[3].y}],[{x:t[3].x,y:t[3].y},{x:t[0].x,y:t[0].y}]];var a=s(i(t)),r=s(i(e));for(let t=0;t<a.length;t++)for(let e=0;e<r.length;e++){let i=a[t][0].x,s=a[t][0].y,h=a[t][1].x,n=a[t][1].y,o=r[e][0].x,l=r[e][0].y,y=r[e][1].x,c=r[e][1].y;if(Canvas.doLinesIntersect(i,s,h,n,o,l,y,c))return!0}var h=t.getCorners()[0];if(h=Canvas.absolutePoint(h.x,h.y,t.x,t.y,t.rotation),Canvas.isOverLayer(h.x,h.y,e))return!0;var n=e.getCorners()[0];return n=Canvas.absolutePoint(n.x,n.y,e.x,e.y,e.rotation),!!Canvas.isOverLayer(n.x,n.y,t)}canMoveActiveLayer(t,e){const i=this.isNewPosInBounds(this.activeLayer,t,e,this.activeLayer.width,this.activeLayer.height);if(this.activeLayer.forceBoundary&&!i)return!1;var s=this.activeLayer.x,a=this.activeLayer.y;this.activeLayer.x=t,this.activeLayer.y=e;for(var r=!0,h=0;h<this.layers.length;h++)if(this.layers[h]!==this.activeLayer&&(!this.activeLayer.allowOverlap||!this.layers[h].allowOverlap)&&this.doLayersOverlap(this.activeLayer,this.layers[h])){r=!1;break}return this.activeLayer.x=s,this.activeLayer.y=a,r}canResizeActiveLayer(t,e){const i=this.isNewPosInBounds(this.activeLayer,this.activeLayer.x,this.activeLayer.y,t,e);if(this.activeLayer.forceBoundary&&!i)return!1;var s=this.activeLayer.width,a=this.activeLayer.height;this.activeLayer.width=s,this.activeLayer.height=a;for(var r=!0,h=0;h<this.layers.length;h++)if(this.layers[h]!==this.activeLayer&&(!this.activeLayer.allowOverlap||!this.layers[h].allowOverlap)&&this.doLayersOverlap(this.activeLayer,this.layers[h])){r=!1;break}return this.activeLayer.width=s,this.activeLayer.height=a,r}canRotateActiveLayer(t){var e=this.activeLayer.rotation;this.activeLayer.rotation=t;const i=this.isNewPosInBounds(this.activeLayer,this.activeLayer.x,this.activeLayer.y,this.activeLayer.width,this.activeLayer.height);if(this.activeLayer.forceBoundary&&!i)return!1;for(var s=!0,a=0;a<this.layers.length;a++)if(this.layers[a]!==this.activeLayer&&(!this.activeLayer.allowOverlap||!this.layers[a].allowOverlap)&&this.doLayersOverlap(this.activeLayer,this.layers[a])){s=!1;break}return this.activeLayer.rotation=e,s}onmousemove(t){var{x:e,y:i}=this.canvasMousePos(t);if(this.setCursor(e,i),null!==this.activeLayer)if(this.rotatingActiveLayer){var s=e-this.activeLayer.x,a=i-this.activeLayer.y,r=180*Math.atan2(a,s)/Math.PI;if(!this.canRotateActiveLayer(r))return this.rotatingActiveLayer=!1,void this.draw();this.fireEvent("layer-rotate")&&(this.activeLayer.rotation=r,this.activeLayer instanceof CanvasLayerGroup&&this.activeLayer.updateLayers(),this.draw())}else if(this.draggingActiveLayer){const t=this.activeLayerMouseOffset.x+e,s=this.activeLayerMouseOffset.y+i;if(!this.canMoveActiveLayer(t,s))return this.draggingActiveLayer=!1,void this.draw();if(this.fireEvent("layer-drag")){var h=t-this.activeLayer.x,n=s-this.activeLayer.y;this.activeLayer.x+=h,this.activeLayer.y+=n,this.activeLayer instanceof CanvasLayerGroup&&this.activeLayer.updateLayers(),this.draw()}}else if(this.resizingActiveLayer){const{width:t,height:s}=this.calculateLayerResize(e,i);if(!this.canResizeActiveLayer(t,s))return this.draggingActiveLayer=!1,void this.draw();this.fireEvent("layer-resize")&&(this.activeLayer.width=t,this.activeLayer.height=s,this.activeLayer instanceof CanvasLayerGroup&&this.activeLayer.updateLayers(),this.draw())}}setCursor(t,e){this.rotatingActiveLayer?document.body.style.cursor=this.cursors.rotating:this.draggingActiveLayer?document.body.style.cursor=this.cursors.grabbing:this.resizingActiveLayer?document.body.style.cursor=this.cursors.move:this.isNearActiveCorner(t,e)?document.body.style.cursor=this.cursors.move:this.isNearActiveRotatePoint(t,e)?document.body.style.cursor=this.cursors.rotate:this.isOverSelectableLayer(t,e)?document.body.style.cursor=this.cursors.grab:document.body.style.cursor=this.cursors.default}calculateLayerResize(t,e){var i=this.activeLayer.width,s=this.activeLayer.height,a=this.lastMouseDownOffset,r=Canvas.layerRelativePoint(t,e,this.activeLayer);if(i=a.x>0?Math.abs(this.activeLayerOriginalDimensions.width-2*(a.x-r.x)):Math.abs(this.activeLayerOriginalDimensions.width-2*(r.x-a.x)),s=a.y>0?Math.abs(this.activeLayerOriginalDimensions.height-2*(a.y-r.y)):Math.abs(this.activeLayerOriginalDimensions.height-2*(r.y-a.y)),this.shiftKeyDown){var h=Math.min(i/this.activeLayerOriginalDimensions.width,s/this.activeLayerOriginalDimensions.height);i=this.activeLayerOriginalDimensions.width*h,s=this.activeLayerOriginalDimensions.height*h}return{width:i,height:s}}fireEvent(t){var e=new CustomEvent(t,{detail:this,cancelable:!0,bubbles:!0});return this.canvas.dispatchEvent(e)}onclick(t){var{x:e,y:i}=this.canvasMousePos(t),s=this.getLayerAt(e,i);s&&(this.last_clicked_layer=s,this.fireEvent("layer-click"))}ondblclick(t){var{x:e,y:i}=this.canvasMousePos(t),s=this.getLayerAt(e,i);s&&(this.last_clicked_layer=s,this.fireEvent("layer-dblclick"))}async onmousedown(t){var{x:e,y:i}=this.canvasMousePos(t);if(this.setCursor(e,i),this.isNearActiveRotatePoint(e,i))this.fireEvent("layer-rotate-start")&&(this.activeLayerRotateStartPos={x:e,y:i},this.rotatingActiveLayer=!0);else if(this.isNearActiveCorner(e,i))this.fireEvent("layer-resize-start")&&(this.resizingActiveLayer=!0);else{var s,a=!1;null!==(s=this.getLayerAt(e,i))&&!1===s.selectable&&(s=null),null!==s&&null!==this.activeLayer&&s!==this.activeLayer&&((a=!this.fireEvent("layer-deselect"))||this.deSelectLayer()),!a&&null!==s&&this.fireEvent("layer-drag-start")&&(this.activeLayerMouseOffset.x=s.x-e,this.activeLayerMouseOffset.y=s.y-i,s.draggable&&(this.draggingActiveLayer=!0),s!==this.activeLayer&&this.fireEvent("layer-select")&&this.selectLayer(s))}this.activeLayer&&(this.activeLayerOriginalDimensions={width:this.activeLayer.width,height:this.activeLayer.height},this.lastMouseDownOffset=Canvas.layerRelativePoint(e,i,this.activeLayer)),(s=this.getLayerAt(e,i))&&s!==this.ctrlGroupLayer&&s.selectable&&(this.isCtrlPressed||this.destroyCtrlGroup(),this.isLayerInGroup(s)||(this.muteStateChanges=!0,await this.ctrlGroupLayer.addLayer(s),1===this.ctrlGroupLayer.layers.length&&this.selectLayer(s),s.onload(()=>{this.muteStateChanges=!1})),!this.isGroupOnCanvas()&&this.ctrlGroupLayer.layers.length>1&&(this.muteStateChanges=!0,this.ctrlGroupLayer.layers.forEach(t=>{this.removeLayer(t)}),this.addLayer(this.ctrlGroupLayer),this.ctrlGroupLayer.onload(()=>{this.muteStateChanges=!1})),this.isGroupOnCanvas()&&this.selectLayer(this.ctrlGroupLayer))}isNearActiveRotatePoint(t,e){if(!this.activeLayer||!this.activeLayer.rotateable)return!1;var{x:t,y:e}=Canvas.layerRelativePoint(t,e,this.activeLayer),i=this.activeLayer.width/2+25;return Math.hypot(i-t,0-e)<=this.getScale()*this.anchorRadius}isNearActiveCorner(t,e){if(!this.activeLayer||!this.activeLayer.resizable)return!1;var{x:t,y:e}=Canvas.layerRelativePoint(t,e,this.activeLayer),i=!1;return this.activeLayer.getCorners().forEach(s=>{Math.hypot(s.x-t,s.y-e)<=this.getScale()*this.anchorRadius&&(i=!0)}),i}isNewPosInBounds(t,e,i,s,a){var r=t.x,h=t.y,n=t.width,o=t.height;t.x=e,t.y=i,t.width=s,t.height=a;var l=!0;return t.getCorners().forEach(e=>{var i=Canvas.absolutePoint(e.x,e.y,t.x,t.y,t.rotation);(i.x<0||i.x>this.width||i.y<0||i.y>this.width)&&(l=!1)}),t.x=r,t.y=h,t.width=n,t.height=o,l}getNearestGridline(t,e){return Object.values(e.reduce((e,i)=>(i>t?null===e.high?e.high=i:e.high=Math.min(e.high,i):null===e.low?e.low=i:e.low=Math.max(e.low,i),e),{low:null,high:null})).reduce((e,i)=>{var s=Math.abs(i-t),a=null===e?null:Math.abs(e-t);return(null===e||s<a)&&(e=i),e},null)}onmousereset(t){if(this.draggingActiveLayer&&this.fireEvent("layer-drag-end"),this.resizingActiveLayer&&this.fireEvent("layer-resize-end"),this.rotatingActiveLayer&&this.fireEvent("layer-rotate-end"),this.draggingActiveLayer&&this.snapToGrid&&this.activeLayer){var{xs:e,ys:i}=this.getGridLines(),s=this.getNearestGridline(this.activeLayer.x,e),a=this.getNearestGridline(this.activeLayer.y,i),r=!1,h=Math.abs(s-this.activeLayer.x);h<=this.gridDistancePixels&&0!==h&&(this.activeLayer.x=s,r=!0),(h=Math.abs(a-this.activeLayer.y))<=this.gridDistancePixels&&0!==h&&(this.activeLayer.y=a,r=!0),r&&this.draw()}(this.draggingActiveLayer||this.resizingActiveLayer||this.rotatingActiveLayer)&&this.saveState();var{x:n,y:o}=this.canvasMousePos(t);this.draggingActiveLayer=!1,this.resizingActiveLayer=!1,this.rotatingActiveLayer=!1,this.lastMouseDownOffset={x:0,y:0},this.activeLayerMouseOffset={x:0,y:0},this.activeLayerOriginalDimensions={width:0,height:0},this.activeLayerRotateStartPos={x:0,y:0},this.setCursor(n,o)}getScale(){var t=this.canvas.getBoundingClientRect();return this.canvas.width/t.width}}Canvas.version="2.1.2",Canvas.anchorRadius=8,Canvas.strokeStyle="#ba0000",Canvas.fillStyle="black",Canvas.lineWidth=5,Canvas.cursors={default:null,grab:"grab",grabbing:"grabbing",move:"crosshair",rotate:"grab",rotating:"grabbing"},Canvas.absolutePoint=((t,e,i,s,a)=>{var r=a*(Math.PI/180),h=Math.cos(r),n=Math.sin(r);return{x:i+t*h-e*n,y:s+t*n+e*h}}),Canvas.relativePoint=((t,e,i,s,a)=>{t-=i,e-=s;var r=a*(Math.PI/180),h=Math.cos(r),n=Math.sin(r),o=t*h+e*n,l=-t*n+e*h;return{x:o=Math.floor(100*o)/100,y:l=Math.floor(100*l)/100}}),Canvas.layerRelativePoint=((t,e,i)=>Canvas.relativePoint(t,e,i.x,i.y,i.rotation)),Canvas.isOverLayer=((t,e,i)=>{let s=Canvas.layerRelativePoint(t,e,i);return!(s.x>i.width/2)&&(!(s.x<-i.width/2)&&(!(s.y>i.height/2)&&!(s.y<-i.height/2)))}),Canvas.doLinesIntersect=((t,e,i,s,a,r,h,n)=>{var o,l,y;return 0!==(o=(i-t)*(n-r)-(h-a)*(s-e))&&(l=((e-s)*(h-t)+(i-t)*(n-e))/o,0<(y=((n-r)*(h-t)+(a-h)*(n-e))/o)&&y<1&&0<l&&l<1)});class CanvasLayer{constructor(t,e,i,s,a=null,r=null,h=0,n=!0,o=!0,l=!0,y=!0,c=!1,d=!0){this.name=e,this.url=t,this.ready=!1,this.image=null,this.x=i,this.y=s,this.width=a,this.height=r,this.rotation=h,this.draggable=n,this.rotateable=o,this.resizable=l,this.selectable=y,this.forceBoundary=c,this.allowOverlap=d,this.load_cb_stack=[],this.xoffset=0,this.yoffset=0,this.roffset=0,this.owidth=0,this.oheight=0,this.load()}objectify(){return{layer:this,state:{name:this.name,url:this.url,x:this.x,y:this.y,width:this.width,height:this.height,rotation:this.rotation,draggable:this.draggable,rotatable:this.rotateable,resizable:this.resizable,selectable:this.selectable,forceBoundary:this.forceBoundary}}}onload(t){this.ready?t():this.load_cb_stack.push(t)}load(){return new Promise(t=>{if(this.ready)t();else{const e=new Image;e.onload=(()=>{this.image=e,null===this.width&&(this.width=e.width),null===this.height&&(this.height=e.height),this.ready=!0,this.load_cb_stack.forEach(t=>t()),this.load_cb_stack=[],t()}),e.src=this.url}})}getCorners(){return[{x:-this.width/2,y:-this.height/2},{x:-this.width/2+this.width,y:-this.height/2},{x:-this.width/2+this.width,y:-this.height/2+this.height},{x:-this.width/2,y:-this.height/2+this.height}]}}CanvasLayer.deobjectify=function(t){var e=t.layer;return Object.keys(t.state).forEach(i=>{e[i]=t.state[i]}),e};class CanvasLayerGroup extends CanvasLayer{constructor(t,e=!0,i=!0,s=!0,a=!0,r=!1){super("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/1+yHgAHtAKYD9BncgAAAABJRU5ErkJggg==",t,0,0,1,1,0,e,i,s,a,r),this.layers=[]}getLayerOrSubLayerAt(t,e,i){for(let s=0;s<t.layers.length;s++){let a=t.layers[s];if(a===this)for(let t=this.layers.length;t--;){let s=this.layers[t];if(Canvas.isOverLayer(e,i,s))return s}if(Canvas.isOverLayer(e,i,a))return a}return null}async removeLayer(t){return delete t.xoffset,delete t.yoffset,this.layers.splice(this.layers.indexOf(t),1),await this.regenerate()}async addLayer(t){if(t!==this)return t instanceof CanvasLayerGroup?this.layers.push(...t.layers):this.layers.push(t),await this.regenerate()}async regenerate(){var t=await this.getParams();return this.width=this.owidth=t.width,this.height=this.oheight=t.height,this.x=t.x,this.y=t.y,this.rotation=0,this.forceBoundary=t.forceBoundary,this.draggable=t.draggable,this.rotateable=t.rotateable,this.resizable=t.resizable,this.selectable=t.selectable,this.url=t.uri,this.ready=!1,await this.load()}updateLayers(){var t=this.width/this.owidth,e=this.height/this.oheight;this.layers.forEach(i=>{i.width=i.owidth*t,i.height=i.oheight*e,i.rotation=i.roffset+this.rotation;var s=Canvas.absolutePoint(i.xoffset*t,i.yoffset*e,this.x,this.y,this.rotation);i.x=s.x,i.y=s.y})}async getParams(){const t=[];this.layers.map(t=>t.getCorners().map(e=>Canvas.absolutePoint(e.x,e.y,t.x,t.y,t.rotation))).forEach(e=>{t.push(...e)});var e={left:t.reduce((t,e)=>Math.min(t,e.x),1/0),top:t.reduce((t,e)=>Math.min(t,e.y),1/0),right:t.reduce((t,e)=>Math.max(t,e.x),0),bottom:t.reduce((t,e)=>Math.max(t,e.y),0)};e.width=e.right-e.left,e.height=e.bottom-e.top,e.x=e.left+e.width/2,e.y=e.top+e.height/2;var i=document.createElement("canvas");i.width=e.right+2,i.height=e.bottom+2;var s=new Canvas(i);return this.layers.forEach(t=>s.addLayer(t)),e.uri=await s.extractPortion(e.x,e.y,e.width,e.height,0,!1),e.forceBoundary=this.layers.reduce((t,e)=>e.forceBoundary||t,!1),e.draggable=this.layers.reduce((t,e)=>!1!==t&&e.draggable,!0),e.rotateable=this.layers.reduce((t,e)=>!1!==t&&e.draggable,!0),e.resizable=this.layers.reduce((t,e)=>!1!==t&&e.draggable,!0),e.selectable=this.layers.reduce((t,e)=>!1!==t&&e.draggable,!0),this.layers.forEach(t=>{t.xoffset=t.x-e.x,t.yoffset=t.y-e.y,t.roffset=t.rotation,t.owidth=t.width,t.oheight=t.height}),e}}class DrawingCanvas extends Canvas{constructor(t,e={}){super(t,e),this.drawing_mode=null,this.line_color="#000000",this.fill_color="#0000FF",this.shape_start_pos=null,this.is_mouse_down=!1,this.freehand_coords=[],this.rcanvas=document.createElement("canvas"),this.rcanvas.height=this.height,this.rcanvas.width=this.width,this.rctx=this.rcanvas.getContext("2d"),this.ccanvas=document.createElement("canvas"),this.cctx=this.ccanvas.getContext("2d"),this.drawing_layer=null,this.layer_dimensions=null}setLineWidth(t){this.rctx.lineWidth=+t}setStrokeStyle(t){this.rctx.strokeStyle=t}setFillStyle(t){this.rctx.fillStyle=t}drawEllipse(t,e,i,s,a){var r=s/2*.5522848,h=a/2*.5522848,n=e+s,o=i+a,l=e+s/2,y=i+a/2;t.save(),t.beginPath(),t.moveTo(e,y),t.bezierCurveTo(e,y-h,l-r,i,l,i),t.bezierCurveTo(l+r,i,n,y-h,n,y),t.bezierCurveTo(n,y+h,l+r,o,l,o),t.bezierCurveTo(l-r,o,e,y+h,e,y),t.fill(),t.stroke(),t.restore()}renderLayer(){const{x:t,y:e,width:i,height:s}=this.layer_dimensions;this.ccanvas.width=i,this.ccanvas.height=s,this.cctx.clearRect(0,0,i,s),this.cctx.drawImage(this.rcanvas,t,e,i,s,0,0,i,s);var a=this.ccanvas.toDataURL();const r=t+i/2,h=e+s/2;this.drawing_layer?(this.drawing_layer.x=r,this.drawing_layer.y=h,this.drawing_layer.width=i,this.drawing_layer.height=s,this.drawing_layer.url=a,this.drawing_layer.ready=!1,this.drawing_layer.image=null,this.drawing_layer.load().then(()=>this.draw())):this.drawing_layer=this.addLayer(a,{xpos:r,ypos:h})}recalculateLayerDimensions(t){var e,i,s,a;if("freehand"===this.drawing_mode){this.freehand_coords.push(t);var r=this.freehand_coords.map(t=>t.x),h=this.freehand_coords.map(t=>t.y);e=Math.min(...r),i=Math.min(...h);var n=Math.max(...r),o=Math.max(...h);s=Math.max(.1,Math.abs(e-n)),a=Math.max(.1,Math.abs(i-o))}else e=Math.min(this.shape_start_pos.x,t.x),i=Math.min(this.shape_start_pos.y,t.y),s=Math.max(.1,Math.abs(this.shape_start_pos.x-t.x)),a=Math.max(.1,Math.abs(this.shape_start_pos.y-t.y));this.layer_dimensions={x:e,y:i,width:s,height:a}}onmousemove(t){if(!this.drawing_mode)return super.onmousemove(t);if(!this.is_mouse_down)return;this.rctx.clearRect(0,0,this.width,this.height);const e=this.canvasMousePos(t);switch(this.recalculateLayerDimensions(e),this.drawing_mode){case"rectangle":var{x:i,y:s,width:a,height:r}=this.layer_dimensions;this.rctx.beginPath(),this.rctx.rect(i,s,a,r),this.rctx.fill(),this.rctx.stroke(),this.renderLayer();break;case"ellipse":var{x:i,y:s,width:a,height:r}=this.layer_dimensions;this.drawEllipse(this.rctx,i,s,a,r),this.renderLayer();break;case"line":var h=this.shape_start_pos.x,n=this.shape_start_pos.y,o=e.x,l=e.y;this.rctx.beginPath(),this.rctx.moveTo(h,n),this.rctx.lineTo(o,l),this.rctx.fill(),this.rctx.stroke(),this.renderLayer();break;case"freehand":if(this.freehand_coords<2)break;for(var y=this.freehand_coords[0],c=1;c<this.freehand_coords.length;c++)this.rctx.beginPath(),this.rctx.moveTo(y.x,y.y),this.rctx.lineTo(this.freehand_coords[c].x,this.freehand_coords[c].y),this.rctx.fill(),this.rctx.stroke(),y=this.freehand_coords[c];this.renderLayer()}}onmousedown(t){if(!this.drawing_mode)return super.onmousedown(t);this.is_mouse_down=!0,this.shape_start_pos=this.canvasMousePos(t)}onmousereset(t){if(!this.drawing_mode)return super.onmousereset(t);this.is_mouse_down=!1,this.shape_start_pos=null,this.drawing_layer=null,this.layer_dimensions=null,this.freehand_coords=[]}}export{Canvas,CanvasLayer,CanvasLayerGroup,DrawingCanvas};